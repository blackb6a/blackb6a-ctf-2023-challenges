

# This file was *autogenerated* from the file solve.sage
from sage.all_cmdline import *   # import sage library

_sage_const_4096 = Integer(4096); _sage_const_16384 = Integer(16384); _sage_const_1 = Integer(1); _sage_const_513 = Integer(513); _sage_const_2 = Integer(2); _sage_const_4 = Integer(4); _sage_const_256 = Integer(256); _sage_const_512 = Integer(512); _sage_const_0 = Integer(0)
from pwn import *
from colorama import Fore, Style


def generate_pf():
    np = list(prime_range(_sage_const_4096 , _sage_const_16384 ))
    cand = []
    while True:
        tmp = set()
        prod = _sage_const_1   # 2q - 1
        while prod.nbits() < _sage_const_513 :
            c = choice(np)
            if c not in tmp:
                tmp.add(c)
                prod *= c

        if prod.nbits() != _sage_const_513 :
            continue

        q = (prod + _sage_const_1 ) // _sage_const_2 
        if is_prime(_sage_const_4  * q - _sage_const_1 ):
            return q, sorted(list(tmp))


def dlog(g, a):
    k, r = _sage_const_1 , g
    while r != a:
        r *= g
        k += _sage_const_1 
    return k


def main():
    q, pf = generate_pf()
    print("pf:", pf)

    assert product(pf) == _sage_const_2  * q - _sage_const_1 
    # p = -4 * q + 1
    p = _sage_const_4  * q - _sage_const_1 

    r = process('python3 ../src/chall.py', shell=True)
    for _ in range(_sage_const_256 ):
        print(f"Challenge {_ + _sage_const_1 }!")

        try:
            r.recvuntil(b'q = ')
        except EOFError:
            print('[EOFError] Failed...')
            r.close()
            return

        r.sendline(str(-q).encode())

        r.recvuntilb('g = ')
        g = ZZ(r.recvline())

        r.recvuntil(b'h = ')
        h = ZZ(r.recvline())

        g, h = GF(p)(g), GF(p)(h)

        # g^x == h mod p
        rem, mods = [], []
        phi = p - _sage_const_1 
        for _p in [_sage_const_2 ] + pf:
            _g = g ** (phi // _p)
            _h = h ** (phi // _p)
            _d = dlog(_g, _h)
            _ord = dlog(_g, _sage_const_1 )

            if _ord != _p:
                print(f"[!] Reduced order: {_p} -> {_ord}")
            rem.append(_d)
            mods.append(_ord)

        _sol = CRT(rem, mods)
        _mod = LCM(mods)

        sols = _sage_const_1  + (_sage_const_2  ** _sage_const_512  - _sol) // _mod
        if sols > _sage_const_1 :
            print('[Oh no!] Number of sols in [0, 2^512):', sols)

        r.recvuntil(b'x = ')
        r.sendline(str(_sol).encode())

    r.recvuntil(b'[*] ')
    flag = r.recvline().strip().decode()
    print(f'{Fore.CYAN}Flag: {flag}{Style.RESET_ALL}')
    exit(_sage_const_0 )


if __name__ == '__main__':
    while True:
        main()

